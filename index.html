<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Seguimiento Docente 2026 - Tierra</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root { --dark-green: #064e3b; --dark-brown: #451a03; --vibrant-yellow: #facc15; --cream-white: #fafaf9; }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--cream-white); color: var(--dark-brown); margin: 0; padding: 0; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .earth-card { background: #ffffff; border: 1px solid #d6d3d1; border-radius: 16px; box-shadow: 0 2px 8px rgba(69, 26, 3, 0.08); }
    .nav-active { color: var(--dark-green); font-weight: 800; }
    .nav-active svg { fill: var(--vibrant-yellow); stroke: var(--dark-green); }
    input, select, textarea { border: 1.5px solid #a8a29e !important; background: #ffffff !important; border-radius: 12px !important; color: var(--dark-brown) !important; outline: none !important; }
    .table-earth { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .table-earth tr { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .table-earth td, .table-earth th { padding: 12px; text-align: left; }
    .table-earth th { font-size: 10px; text-transform: uppercase; font-weight: 900; color: #78716c; }
    .chat-bubble { max-width: 85%; padding: 10px; border-radius: 14px; font-size: 12px; font-weight: 700; margin-bottom: 8px; }
    .chat-bubble.user { background: #f3f4f6; color: #1f2937; border: 1px solid #e5e7eb; border-bottom-left-radius: 2px; }
    .chat-bubble.docente { background: var(--dark-green); color: var(--vibrant-yellow); align-self: flex-end; border-bottom-right-radius: 2px; }
    /* Estilo para bot√≥n deshabilitado */
    button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
  </style>
</head>

<body class="antialiased overflow-hidden">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const Icon = ({ children, size = 24, className = "" }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg> );
    const Home = (p)=><Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>;
    const Book = (p)=><Icon {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></Icon>;
    const Plus = (p)=><Icon {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>;
    const MessageCircle = (p)=><Icon {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></Icon>;
    const Database = (p)=><Icon {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>;
    const Settings = (p)=><Icon {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Icon>;
    const EditIcon = (p)=><Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>;
    const TrashIcon = (p)=><Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1-2-2h4a2 2 0 0 1 2 2v2"/></Icon>;
    const Send = (p)=><Icon {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>;
    const VideoIcon = (p)=><Icon {...p}><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></Icon>;
    const FileText = (p)=><Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></Icon>;
    const ArchiveIcon = (p)=><Icon {...p}><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></Icon>;
    const RestoreIcon = (p)=><Icon {...p}><polyline points="16 14 12 9 8 14"/><path d="M12 9v12"/><path d="M20 20h-8a6 6 0 0 1-6-6V8"/><path d="M4 8h16"/></Icon>;
    const SaveIcon = (p)=><Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
    const BoardIcon = (p)=><Icon {...p}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></Icon>;

    const gradeLevels = ['Primero', 'Segundo', 'Tercero', 'Cuarto', 'Quinto'];
    const areasList = ['INGLES', 'CIENCIAS NATURALES', 'CIENCIAS SOCIALES', 'ARTISTICA', 'EDUCACION FISICA', 'ETICA Y VALORES', 'RELIGION', 'ESPA√ëOL (LENGUAJE)', 'MATEMATICAS', 'TECNOLOGIA E INFORMATICA'];

    const App = () => {
      const URL_IMAGEN_ALERTA = "https://cdn-icons-png.flaticon.com/512/564/564619.png"; 

      const [view, setView] = useState('recent');
      const [studentsData, setStudentsData] = useState([]);
      const [studentLists, setStudentLists] = useState({});
      const [periodoActual, setPeriodoActual] = useState(1);
      const [periodoVisualizacion, setPeriodoVisualizacion] = useState(1);
      const [isSaving, setIsSaving] = useState(false); // CANDADO ANTI-DOBLE CLICK
      
      const [isFormOpen, setIsFormOpen] = useState(false);
      const [isConfigOpen, setIsConfigOpen] = useState(false);
      const [isBoardOpen, setIsBoardOpen] = useState(false);

      const [batchData, setBatchData] = useState({ gradeLevel: '', area: '', actividad: '', entries: [] });
      const [agendaItems, setAgendaItems] = useState([]);
      const [assignmentType, setAssignmentType] = useState('group');
      const [selectedGrades, setSelectedGrades] = useState([]);
      const [newTask, setNewTask] = useState({ gradeLevel:'Quinto', area:'', title:'', description:'', date:'', targetStudent:'', videoLink: '', pdfLink: '', publishAt: '' });
      const [editingTask, setEditingTask] = useState(null);
      const [inboxMessages, setInboxMessages] = useState([]);
      const [replyText, setReplyText] = useState({});
      const [agendaTab, setAgendaTab] = useState('published');
      const [mailboxTab, setMailboxTab] = useState('active');
      
      const [noticeText, setNoticeText] = useState('');
      const [noticeColor, setNoticeColor] = useState('yellow');
      const [noticeImage, setNoticeImage] = useState('');
      const [noticeVideo, setNoticeVideo] = useState('');
      const [noticeScope, setNoticeScope] = useState('General'); 
      const [noticeTargets, setNoticeTargets] = useState(['Todos']); 
      const [targetStudentDoc, setTargetStudentDoc] = useState('');
      const [noticesList, setNoticesList] = useState([]);
      const [editingNoticeId, setEditingNoticeId] = useState(null);
      const [noticeTab, setNoticeTab] = useState('active');

      const [noticePublishAt, setNoticePublishAt] = useState('');
      const [noticeExpiresAt, setNoticeExpiresAt] = useState('');

      const [filterGrade, setFilterGrade] = useState('Quinto');
      const [filterArea, setFilterArea] = useState('MATEMATICAS');
      const [filterActivity, setFilterActivity] = useState('');
      const [filterStudent, setFilterStudent] = useState('');
      const [editingGradeEntry, setEditingGradeEntry] = useState(null);

      const [agendaFilterGrade, setAgendaFilterGrade] = useState('');
      const [agendaFilterArea, setAgendaFilterArea] = useState('');
      const [agendaFilterDate, setAgendaFilterDate] = useState('');

      useEffect(() => {
        db.collection("configuracionGlobal").doc("notas").onSnapshot(s => {
          const p = s.exists ? s.data().periodoActual || 1 : 1;
          setPeriodoActual(p);
          setPeriodoVisualizacion(p);
        });
        db.collection("configuracionGlobal").doc("listasEstudiantes").onSnapshot(s => setStudentLists(s.exists ? s.data() : {}));
      }, []);

      useEffect(() => {
        const unsubNotes = db.collection("notasAcademicas").onSnapshot(s => {
          const a=[]; s.forEach(d=> { if((d.data().periodo || 1) === periodoVisualizacion) a.push({id:d.id,...d.data()}); }); 
          setStudentsData(a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0)));
        });
        const unsubAgenda = db.collection("agendaEscolar").onSnapshot(s => {
          const a=[]; s.forEach(d=> { if((d.data().periodo || 1) === periodoVisualizacion) a.push({id:d.id,...d.data()}); }); 
          setAgendaItems(a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0)));
        });
        const unsubMessages = db.collection("mensajesAgenda").onSnapshot(s => {
          const a=[]; s.forEach(d=> { if((d.data().periodo || 1) === periodoVisualizacion) a.push({id:d.id,...d.data()}); }); 
          setInboxMessages(a.sort((x,y)=>(y.lastUpdate||'').localeCompare(x.lastUpdate||'')));
        });
        const unsubNotices = db.collection("tableroAvisos").orderBy("timestamp", "desc").onSnapshot(s => {
            setNoticesList(s.docs.map(d => ({id:d.id, ...d.data()})));
        });
        return () => { unsubNotes(); unsubAgenda(); unsubMessages(); unsubNotices(); };
      }, [periodoVisualizacion]);

      const updateGlobalPeriod = async (p) => {
        await db.collection("configuracionGlobal").doc("notas").set({ periodoActual: p }, { merge: true });
        setPeriodoActual(p);
        setPeriodoVisualizacion(p);
        Swal.fire({ icon: 'success', title: `Periodo ${p} Activo`, toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
      };

      const handleBatchConfigChange = (e) => {
        const { name, value } = e.target;
        setBatchData(prev => {
          const newData = { ...prev, [name]: value };
          if (name === 'gradeLevel') {
            const list = value ? (studentLists[value] || []) : [];
            newData.entries = list.map(n => ({ name: n, score: '', observation: '' }));
          }
          return newData;
        });
      };
      
      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 800000) return Swal.fire('Foto muy pesada', 'M√°x 800kb', 'error');
          const reader = new FileReader();
          reader.onloadend = () => setNoticeImage(reader.result);
          reader.readAsDataURL(file);
        }
      };

      const toggleNoticeTarget = (target) => {
        if (target === 'Todos') { setNoticeTargets(['Todos']); } else {
            let newTargets = noticeTargets.filter(t => t !== 'Todos');
            if (newTargets.includes(target)) newTargets = newTargets.filter(t => t !== target);
            else newTargets.push(target);
            if (newTargets.length === 0) newTargets = ['Todos'];
            setNoticeTargets(newTargets);
        }
      };

      const handlePublishNotice = async () => {
        if(isSaving) return; // BLOQUEO
        if(!noticeText.trim() && !noticeImage) return Swal.fire('Error', 'Escribe o sube foto', 'warning');
        if(noticeScope === 'Individual' && !targetStudentDoc) return Swal.fire('Error', 'Selecciona un estudiante', 'warning');
        
        setIsSaving(true);
        const payload = {
            mensaje: noticeText, color: noticeColor, imageUrl: noticeImage, videoUrl: noticeVideo,
            scope: noticeScope,
            targetGrades: noticeScope === 'Grado' ? noticeTargets : (noticeScope === 'General' ? ['Todos'] : []),
            targetStudentDoc: noticeScope === 'Individual' ? targetStudentDoc : null,
            fecha: new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' }),
            timestamp: new Date().toISOString(),
            archived: false,
            likes: [],
            publishAt: noticePublishAt || null,
            expiresAt: noticeExpiresAt || null
        };

        try {
            if(editingNoticeId) {
                await db.collection("tableroAvisos").doc(editingNoticeId).update(payload);
                setEditingNoticeId(null);
            } else {
                await db.collection("tableroAvisos").add(payload);
            }
            Swal.fire({ icon: 'success', title: 'Guardado', toast: true, position: 'top-end', timer: 1500 });
            setNoticeText(''); setNoticeImage(''); setNoticeVideo(''); setNoticeTargets(['Todos']); setTargetStudentDoc(''); setNoticeScope('General');
            setNoticePublishAt(''); setNoticeExpiresAt('');
        } catch (e) { Swal.fire('Error', 'Error al guardar', 'error'); }
        finally { setIsSaving(false); }
      };

      const prepareEditNotice = (n) => {
        setNoticeText(n.mensaje); setNoticeColor(n.color); setNoticeImage(n.imageUrl || ''); setNoticeVideo(n.videoUrl || '');
        setNoticeScope(n.scope || 'General'); setNoticeTargets(n.targetGrades || ['Todos']); setTargetStudentDoc(n.targetStudentDoc || '');
        setNoticePublishAt(n.publishAt || '');
        setNoticeExpiresAt(n.expiresAt || '');
        setEditingNoticeId(n.id);
        const modalScroll = document.getElementById('board-scroll-container');
        if(modalScroll) modalScroll.scrollTop = 0;
      };

      const archiveNotice = async (n) => {
        await db.collection("tableroAvisos").doc(n.id).update({ archived: !n.archived });
      };

      const deleteNotice = async (id) => {
        if((await Swal.fire({title:'¬øEliminar?', icon:'warning', showCancelButton:true})).isConfirmed){
            await db.collection("tableroAvisos").doc(id).delete();
        }
      };

      const republishTask = (task) => {
        setNewTask({
            gradeLevel: task.gradeLevel,
            area: task.area,
            title: task.title,
            description: task.description,
            date: '', 
            targetStudent: task.targetStudent || '',
            videoLink: task.videoLink || '',
            pdfLink: task.pdfLink || '',
            publishAt: ''
        });

        if(task.targetStudent) {
            setAssignmentType('individual');
        } else {
            setAssignmentType('group');
            setSelectedGrades([task.gradeLevel]);
        }

        const mainContainer = document.querySelector('main');
        if(mainContainer) {
            mainContainer.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        Swal.fire({
            icon: 'info',
            title: 'Listo para republicar',
            text: 'Revisa el grado/estudiante y asigna una nueva fecha arriba.',
            timer: 3000
        });
      };

      const isExpired = (dateStr) => { 
        if(!dateStr) return false; 
        try {
            const now = new Date(); 
            const due = new Date(dateStr + 'T23:59:59'); 
            return !isNaN(due) && now > due; 
        } catch(e) { return false; }
      };

      const handleAddTask = async (status = 'published') => {
        if(isSaving) return; // BLOQUEO
        const isPublished = status === 'published';
        const gradeReady = assignmentType === 'group' ? selectedGrades.length > 0 : !!newTask.gradeLevel;
        if(!gradeReady) return Swal.fire('Error','Debes seleccionar el grado','warning');
        
        setIsSaving(true);
        try {
            const batch = db.batch();
            const baseTask = { 
                ...newTask, 
                status, 
                publico: isPublished, 
                archived: false, 
                createdAt: Date.now(), 
                periodo: periodoActual || 1, 
                publishAt: newTask.publishAt || null 
            };
            
            if(assignmentType === 'group') {
            selectedGrades.forEach(g => {
                const ref = db.collection("agendaEscolar").doc();
                batch.set(ref, { ...baseTask, gradeLevel: g });
            });
            } else {
            batch.set(db.collection("agendaEscolar").doc(), baseTask);
            }

            if (isPublished) {
                const noticeRef = db.collection("tableroAvisos").doc();
                let autoNoticeScope = 'General';
                let autoNoticeTargets = [];
                let autoNoticeStudent = null;
                if (assignmentType === 'group') { autoNoticeScope = 'Grado'; autoNoticeTargets = selectedGrades; } 
                else { autoNoticeScope = 'Individual'; autoNoticeStudent = newTask.targetStudent; }
                
                const pubDate = newTask.publishAt ? new Date(newTask.publishAt) : new Date();
                const expDate = new Date(pubDate);
                expDate.setHours(expDate.getHours() + 24); 
                
                const autoNoticeData = {
                    mensaje: `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Atenci√≥n, familia:\nEl estudiante tiene una nueva actividad asignada.\nüìç √Årea: ${newTask.area || 'General'}\nüìù Trabajo: ${newTask.title}\n‚è≥ Fecha de entrega:\nüóìÔ∏è ${newTask.date || 'Ver Agenda'}\nPor favor ingresa a la agenda para ver todos los detalles.\n‚úÖ ¬°√âxitos!`,
                    color: 'white', 
                    imageUrl: '', videoUrl: newTask.videoLink || '',
                    scope: autoNoticeScope, targetGrades: autoNoticeTargets, targetStudentDoc: autoNoticeStudent,
                    fecha: new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' }),
                    timestamp: new Date().toISOString(), archived: false, likes: [], isSystemNotice: true,
                    publishAt: pubDate.toISOString(), expiresAt: expDate.toISOString()
                };
                batch.set(noticeRef, autoNoticeData);
            }
            await batch.commit();
            setNewTask({ gradeLevel:'Quinto', area:'', title:'', description:'', date:'', targetStudent:'', videoLink: '', pdfLink: '', publishAt: '' });
            setSelectedGrades([]);
            Swal.fire({icon:'success', title: isPublished ? (newTask.publishAt ? 'Programada' : 'Publicada y Aviso Creado') : 'Guardada'});
        } catch (error) {
            console.error(error);
            Swal.fire('Error al guardar', 'Verifica los campos e intenta de nuevo.', 'error');
        } finally { setIsSaving(false); }
      };

      const publishDraft = async (task) => {
         if(isSaving) return;
         setIsSaving(true);
         try {
            const batch = db.batch();
            const taskRef = db.collection("agendaEscolar").doc(task.id);
            batch.update(taskRef, { status: 'published', publico: true, archived: false });

            const noticeRef = db.collection("tableroAvisos").doc();
            let autoNoticeScope = 'General';
            let autoNoticeTargets = [];
            let autoNoticeStudent = null;
            if (task.gradeLevel) { 
                autoNoticeScope = 'Grado'; 
                autoNoticeTargets = [task.gradeLevel]; 
            } 
            if (task.targetStudent) { autoNoticeScope = 'Individual'; autoNoticeStudent = task.targetStudent; }
            
            const pubDate = new Date();
            const expDate = new Date();
            expDate.setHours(expDate.getHours() + 24); 

            const autoNoticeData = {
                mensaje: `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Atenci√≥n, familia:\nEl estudiante tiene una nueva actividad asignada.\nüìç √Årea: ${task.area || 'General'}\nüìù Trabajo: ${task.title}\n‚è≥ Fecha de entrega:\nüóìÔ∏è ${task.date}\nPor favor ingresa a la agenda para ver todos los detalles.\n‚úÖ ¬°√âxitos!`,
                color: 'white', 
                imageUrl: '', videoUrl: task.videoLink || '',
                scope: autoNoticeScope, targetGrades: autoNoticeTargets, targetStudentDoc: autoNoticeStudent,
                fecha: new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' }),
                timestamp: new Date().toISOString(), archived: false, likes: [], isSystemNotice: true,
                publishAt: pubDate.toISOString(), expiresAt: expDate.toISOString()
            };
            batch.set(noticeRef, autoNoticeData);

            await batch.commit();
            Swal.fire({icon:'success', title: 'Borrador Publicado', toast: true, position:'top-end', timer: 1500});
         } catch (error) {
             Swal.fire('Error', 'No se pudo publicar el borrador', 'error');
         } finally { setIsSaving(false); }
      };

      const deleteSingleGrade = async (id) => {
        if((await Swal.fire({title:'¬øEliminar Nota?', text: 'Se eliminar√° solo este registro.', icon:'warning', showCancelButton:true})).isConfirmed){
            await db.collection("notasAcademicas").doc(id).delete();
            Swal.fire({icon:'success', title:'Eliminado', timer:1500, showConfirmButton:false, toast:true, position:'top-end'});
        }
      };

      const saveIndividualGrade = async (en, idx) => {
        if(isSaving) return;
        if (!batchData.area) return Swal.fire('Error', 'Debe seleccionar un √Årea', 'warning');
        
        setIsSaving(true);
        try {
            const nameParts = en.name.lastIndexOf(" - ");
            const finalNota = parseFloat(en.score.replace(',', '.'));
            const studentObj = {
            gradeLevel: batchData.gradeLevel, area: batchData.area, actividad: batchData.actividad.trim(),
            name: en.name, nombreEstudiante: en.name.slice(0, nameParts).trim(), documentoEstudiante: en.name.slice(nameParts + 3).trim(),
            score: en.score.replace(',', '.'), nota: finalNota,
            observacion: en.observation || '', periodo: periodoActual || 1, createdAt: Date.now()
            };
            await db.collection("notasAcademicas").add(studentObj);
            
            if (finalNota < 3.0) {
                await db.collection("tableroAvisos").add({
                    mensaje: `‚ö†Ô∏è ALERTA ACAD√âMICA\nEl estudiante presenta desempe√±o bajo.\n\nüìö √ÅREA: ${studentObj.area}\nüìù ACTIVIDAD: ${studentObj.actividad}\nüìâ NOTA: ${finalNota}\n\nPor favor revisar la secci√≥n de Alertas dentro de Pizarra Escolar para ampliar la informaci√≥n.`,
                    color: 'red',
                    imageUrl: URL_IMAGEN_ALERTA, 
                    videoUrl: "",
                    scope: 'Individual', // PRIVADO
                    targetGrades: [],
                    targetStudentDoc: studentObj.documentoEstudiante, // SOLO PARA ESTE ESTUDIANTE
                    fecha: new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' }),
                    timestamp: new Date().toISOString(),
                    archived: false,
                    likes: [],
                    isSystemNotice: false 
                });
            }

            const newEntries = [...batchData.entries]; newEntries[idx].saved = true; setBatchData({ ...batchData, entries: newEntries });
        } catch(e) { Swal.fire('Error', 'No se pudo guardar la nota', 'error'); }
        finally { setIsSaving(false); }
      };

      const saveGrades = async () => {
        if(isSaving) return;
        if (!batchData.area) return Swal.fire('Error', 'Debe seleccionar un √Årea', 'warning');

        setIsSaving(true);
        try {
            const valid = batchData.entries.filter(e => e.score !== '');
            const batch = db.batch();
            valid.forEach(en => {
            const idx = en.name.lastIndexOf(" - ");
            const finalNota = parseFloat(en.score.replace(',','.'));
            const docEstudiante = en.name.slice(idx+3).trim();
            const nombreEstudiante = en.name.slice(0,idx).trim();
            
            batch.set(db.collection("notasAcademicas").doc(), {
                gradeLevel: batchData.gradeLevel, area: batchData.area, actividad: batchData.actividad.trim(),
                name: en.name, nombreEstudiante: nombreEstudiante, documentoEstudiante: docEstudiante,
                score: en.score.replace(',','.'), nota: finalNota,
                observacion: en.observation || '', periodo: periodoActual || 1, createdAt: Date.now()
            });

            if (finalNota < 3.0) {
                const noticeRef = db.collection("tableroAvisos").doc();
                batch.set(noticeRef, {
                    mensaje: `‚ö†Ô∏è ALERTA ACAD√âMICA\nEl estudiante presenta desempe√±o bajo.\n\nüìö √ÅREA: ${batchData.area}\nüìù ACTIVIDAD: ${batchData.actividad}\nüìâ NOTA: ${finalNota}\n\nPor favor revisar la secci√≥n de Alertas dentro de Pizarra Escolar para ampliar la informaci√≥n.`,
                    color: 'red',
                    imageUrl: URL_IMAGEN_ALERTA,
                    videoUrl: "",
                    scope: 'Individual',
                    targetGrades: [],
                    targetStudentDoc: docEstudiante,
                    fecha: new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' }),
                    timestamp: new Date().toISOString(),
                    archived: false,
                    likes: [],
                    isSystemNotice: false
                });
            }
            });
            await batch.commit();
            setIsFormOpen(false);
            setBatchData({ gradeLevel: '', area: '', actividad: '', entries: [] });
        } catch(e) { Swal.fire('Error', 'Fall√≥ el guardado masivo', 'error'); }
        finally { setIsSaving(false); }
      };

      const generateReportPDF = () => {
        const doc = new window.jspdf.jsPDF();
        const body = filteredRecords.map(r => {
            let notaCell = (r.score || '0').replace('.', ',');
            if (r.recuperada && r.notaAnterior) {
                notaCell = `${r.notaAnterior} -> ${notaCell}`;
            }
            return [r.nombreEstudiante, r.actividad, notaCell];
        });
        doc.autoTable({ head: [['ESTUDIANTE', 'ACTIVIDAD', 'NOTA']], body, headStyles: { fillColor: [6, 78, 59] } });
        doc.save(`Reporte_Notas.pdf`);
      };

      const generateObservationsPDF = () => {
        const doc = new window.jspdf.jsPDF();
        doc.setFontSize(14);
        doc.text(`HIST√ìRICO DE OBSERVACIONES Y ALERTAS - ${filterGrade} - ${filterArea}`, 10, 15);
        const obsRecords = studentsData.filter(s => s.gradeLevel === filterGrade && s.area === filterArea && s.observacion && s.observacion.trim().length > 0);
        const body = obsRecords.map(r => [r.nombreEstudiante, r.actividad, (r.score || '0').replace('.', ','), r.observacion]);
        doc.autoTable({ startY: 20, head: [['ESTUDIANTE', 'ACTIVIDAD', 'NOTA', 'OBSERVACI√ìN/ALERTA']], body, headStyles: { fillColor: [69, 26, 3] }, columnStyles: { 3: { cellWidth: 80 } } });
        doc.save(`Historial_Observaciones_${filterGrade}.pdf`);
      };

      const generateStudentReportPDF = () => {
        if(!filterStudent) return Swal.fire('Error', 'Selecciona un estudiante primero.', 'warning');
        const estRecords = studentsData.filter(s => s.documentoEstudiante === filterStudent);
        if(estRecords.length === 0) return Swal.fire('Sin datos', 'No hay registros para este estudiante.', 'info');
        
        const doc = new window.jspdf.jsPDF();
        const estName = estRecords[0].nombreEstudiante;
        
        doc.setFontSize(14);
        doc.setTextColor(6, 78, 59);
        doc.text(`INFORME ACAD√âMICO INTEGRAL`, 105, 15, null, null, 'center');
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Estudiante: ${estName}`, 10, 25);
        doc.text(`Periodo: ${periodoVisualizacion}`, 10, 30);

        const byArea = {};
        estRecords.forEach(r => {
            if(!byArea[r.area]) byArea[r.area] = [];
            byArea[r.area].push(r);
        });

        let currentY = 35;
        Object.keys(byArea).forEach(area => {
            const rows = byArea[area].map(r => {
                let finalScore = (r.score || '0').replace('.', ',');
                if(r.recuperada && r.notaAnterior) {
                    finalScore = `${r.notaAnterior} -> ${finalScore}`;
                }

                let finalObs = r.observacion || '';
                if(r.recuperada) {
                    finalObs += (finalObs ? ' - ' : '') + 'Trabajo recuperado.';
                } else if (r.nota < 3.0) {
                    finalObs += (finalObs ? ' - ' : '') + 'Nota No recuperada por el estudiante.';
                }

                return [r.actividad, finalScore, finalObs || '-'];
            });

            doc.autoTable({
                startY: currentY + 5,
                head: [[`${area}`, 'NOTA', 'OBSERVACI√ìN']],
                body: rows,
                headStyles: { fillColor: [6, 78, 59] },
                columnStyles: { 2: { cellWidth: 90 } },
                margin: { top: 10 }
            });
            currentY = doc.lastAutoTable.finalY;
        });

        doc.save(`Informe_${estName.replace(/ /g, '_')}.pdf`);
      };

      const generateGeneralAgendaPDF = () => {
        const doc = new window.jspdf.jsPDF();
        const activeTasks = agendaItems.filter(i => !i.archived && i.status !== 'draft');
        const body = activeTasks.map(t => [t.date, t.gradeLevel, t.area, t.title || '']);
        doc.autoTable({ head: [['FECHA', 'GRADO', '√ÅREA', 'T√çTULO']], body, headStyles: { fillColor: [6, 78, 59] } });
        doc.save(`Agenda_General.pdf`);
      };

      const archiveTask = async (task) => {
        await db.collection("agendaEscolar").doc(task.id).update({ archived: true, publico: false });
      };

      const filteredRecords = useMemo(() => {
        let base = studentsData.filter(s => s.gradeLevel === filterGrade);
        if (filterArea === 'SIN_AREA') {
            base = base.filter(s => !s.area || s.area.trim() === '');
        } else if (filterArea) {
            base = base.filter(s => s.area === filterArea);
        }
        if (filterActivity) base = base.filter(r => r.actividad === filterActivity);
        if (filterStudent) base = base.filter(r => r.documentoEstudiante === filterStudent);
        return base;
      }, [studentsData, filterGrade, filterArea, filterActivity, filterStudent]);

      const currentActivities = useMemo(() => {
        let base = studentsData.filter(s => s.gradeLevel === filterGrade);
        if (filterArea === 'SIN_AREA') {
            base = base.filter(s => !s.area || s.area.trim() === '');
        } else if (filterArea) {
            base = base.filter(s => s.area === filterArea);
        }
        return [...new Set(base.map(r => r.actividad))];
      }, [studentsData, filterGrade, filterArea]);

      return (
        <div className="flex flex-col h-[100dvh]">
          {/* CABECERA */}
          <header className="px-6 pt-12 pb-6 bg-[#064e3b] sticky top-0 z-40 shadow-xl">
            <div className="flex justify-between items-center text-white">
              <div>
                <h1 className="text-2xl font-black uppercase tracking-tighter">Docente <span className="text-[#facc15]">2026</span></h1>
                <p className="text-[10px] font-bold text-emerald-200 uppercase">P{periodoVisualizacion} ¬∑ Tierra</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setIsBoardOpen(true)} disabled={isSaving} className="h-12 w-12 rounded-2xl bg-white/10 flex items-center justify-center border border-white/20 active:scale-90 text-[#facc15]"><BoardIcon size={22} /></button>
                <button onClick={() => setIsConfigOpen(true)} disabled={isSaving} className="h-12 w-12 rounded-2xl bg-white/10 flex items-center justify-center border border-white/20 active:scale-90 text-[#facc15]"><Settings size={22} /></button>
              </div>
            </div>
          </header>

          <main className="flex-1 overflow-y-auto p-4 pb-40 no-scrollbar">
            {view === 'recent' && (
              <div className="space-y-4">
                <h2 className="text-[11px] font-black text-stone-600 uppercase px-1">Registros Recientes</h2>
                {studentsData.slice(0, 10).map(s => (
                  <div key={s.id} className="earth-card p-5 flex justify-between items-center">
                    <div className="min-w-0 pr-4">
                      <div className="flex gap-2 mb-1">
                        <span className="text-[9px] font-black bg-stone-100 px-2 py-0.5 rounded uppercase">{s.gradeLevel}</span>
                        <span className="text-[9px] font-black bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded uppercase">{s.area}</span>
                      </div>
                      <h3 className="text-sm font-bold truncate">{s.nombreEstudiante}</h3>
                      <p className="text-[10px] text-stone-500">{s.actividad}</p>
                    </div>
                    <div className="text-right font-black text-[#064e3b] text-2xl">{(s.score||'0').replace('.',',')}</div>
                  </div>
                ))}
              </div>
            )}

            {view === 'agenda' && (
              <div className="space-y-6">
                <div className="earth-card p-6 space-y-4">
                  <h3 className="text-[10px] font-black text-stone-400 uppercase tracking-widest">Nueva Tarea</h3>
                  <div className="flex gap-2 bg-stone-100 p-1 rounded-xl">
                    <button onClick={()=>setAssignmentType('group')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg ${assignmentType==='group'?'bg-white text-emerald-900 shadow-sm':'text-stone-400'}`}>Grupal</button>
                    <button onClick={()=>setAssignmentType('individual')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg ${assignmentType==='individual'?'bg-white text-emerald-900 shadow-sm':'text-stone-400'}`}>Individual</button>
                  </div>
                  {assignmentType === 'group' ? (
                    <div className="grid grid-cols-5 gap-1">
                      {gradeLevels.map(g => (
                        <button key={g} onClick={()=>setSelectedGrades(prev => prev.includes(g) ? prev.filter(x=>x!==g) : [...prev, g])} className={`py-3 rounded-xl text-[10px] font-black border ${selectedGrades.includes(g)?'bg-[#064e3b] text-[#facc15] border-[#064e3b]':'bg-white text-stone-400 border-stone-200'}`}>{g}</button>
                      ))}
                    </div>
                  ) : (
                    <div className="grid grid-cols-2 gap-3">
                      <select value={newTask.gradeLevel} onChange={e=>setNewTask({...newTask,gradeLevel:e.target.value})} className="p-4 text-xs font-black">{gradeLevels.map(g => <option key={g} value={g}>{g}</option>)}</select>
                      <select value={newTask.targetStudent} onChange={e=>setNewTask({...newTask,targetStudent:e.target.value})} className="p-4 text-xs font-black"><option value="">Estudiante...</option>{(studentLists[newTask.gradeLevel] || []).map(name => <option key={name.split(' - ')[1]} value={name.split(' - ')[1]}>{name.split(' - ')[0]}</option>)}</select>
                    </div>
                  )}
                  <select value={newTask.area} onChange={e=>setNewTask({...newTask,area:e.target.value})} className="w-full p-4 text-xs font-black"><option value="">√Årea...</option>{areasList.map(a => <option key={a} value={a}>{a}</option>)}</select>
                  <input type="text" placeholder="T√≠tulo Actividad" value={newTask.title} onChange={e=>setNewTask({...newTask,title:e.target.value})} className="w-full p-4 text-sm font-bold"/>
                  <div className="grid grid-cols-2 gap-3">
                    <input type="date" value={newTask.date} onChange={e=>setNewTask({...newTask,date:e.target.value})} className="w-full p-4 text-xs font-black"/>
                    <div className="flex gap-2">
                        <div className="flex-1 flex items-center justify-center bg-stone-50 rounded-xl border border-dashed border-stone-300"><VideoIcon size={16} className={newTask.videoLink ? 'text-red-600' : 'text-stone-300'}/></div>
                        <div className="flex-1 flex items-center justify-center bg-stone-50 rounded-xl border border-dashed border-stone-300"><FileText size={16} className={newTask.pdfLink ? 'text-blue-600' : 'text-stone-300'}/></div>
                    </div>
                  </div>
                  <input type="url" placeholder="YouTube URL" value={newTask.videoLink} onChange={e=>setNewTask({...newTask,videoLink:e.target.value})} className="w-full p-3 text-[10px] font-black bg-stone-50"/>
                  <input type="url" placeholder="Drive URL" value={newTask.pdfLink} onChange={e=>setNewTask({...newTask,pdfLink:e.target.value})} className="w-full p-3 text-[10px] font-black bg-stone-50"/>
                  <textarea placeholder="Descripci√≥n..." value={newTask.description} onChange={e=>setNewTask({...newTask,description:e.target.value})} className="w-full p-4 text-sm font-bold h-24 resize-none"></textarea>
                  <div className="bg-stone-50 p-3 rounded-xl border border-stone-200">
                    <label className="block text-[9px] font-black text-stone-500 uppercase mb-2">Programar Publicaci√≥n (Opcional)</label>
                    <input type="datetime-local" value={newTask.publishAt} onChange={e=>setNewTask({...newTask, publishAt:e.target.value})} className="w-full p-3 text-[10px] font-black bg-white rounded-lg border border-stone-300"/>
                  </div>
                  <div className="flex gap-2"><button onClick={() => handleAddTask('draft')} disabled={isSaving} className="flex-1 py-4 bg-stone-200 text-stone-600 font-black rounded-2xl text-[11px] uppercase">Borrador</button><button onClick={() => handleAddTask('published')} disabled={isSaving} className="flex-[2] py-4 bg-[#064e3b] text-white font-black rounded-2xl text-[11px] uppercase shadow-lg">Publicar</button></div>
                </div>

                <div className="space-y-4">
                  <button onClick={generateGeneralAgendaPDF} className="w-full py-4 bg-[#facc15] text-[#064e3b] font-black rounded-2xl text-[11px] uppercase shadow-md flex items-center justify-center gap-2"><FileText size={16}/> Descargar Agenda PDF</button>
                  <div className="flex gap-2 bg-stone-100 p-1 rounded-2xl">
                    <button onClick={()=>setAgendaTab('published')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-xl ${agendaTab==='published'?'bg-[#064e3b] text-[#facc15] shadow-md':'text-stone-400'}`}>Publicadas</button>
                    <button onClick={()=>setAgendaTab('draft')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-xl ${agendaTab==='draft'?'bg-[#064e3b] text-[#facc15] shadow-md':'text-stone-400'}`}>Borradores</button>
                    <button onClick={()=>setAgendaTab('archived')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-xl ${agendaTab==='archived'?'bg-[#064e3b] text-[#facc15] shadow-md':'text-stone-400'}`}>Archivadas</button>
                  </div>
                  
                  <div className="bg-stone-50 p-2 rounded-2xl border border-stone-200 grid grid-cols-2 md:grid-cols-3 gap-2 mb-4">
                     <select value={agendaFilterGrade} onChange={e=>setAgendaFilterGrade(e.target.value)} className="w-full p-2 text-[9px] font-black border-none bg-white rounded-xl shadow-sm">
                        <option value="">Todos los Grados</option>
                        {gradeLevels.map(g => <option key={g} value={g}>{g}</option>)}
                     </select>
                     <select value={agendaFilterArea} onChange={e=>setAgendaFilterArea(e.target.value)} className="w-full p-2 text-[9px] font-black border-none bg-white rounded-xl shadow-sm">
                        <option value="">Todas las √Åreas</option>
                        {areasList.map(a => <option key={a} value={a}>{a}</option>)}
                     </select>
                     <input type="date" value={agendaFilterDate} onChange={e=>setAgendaFilterDate(e.target.value)} className="w-full p-2 text-[9px] font-black border-none bg-white rounded-xl shadow-sm col-span-2 md:col-span-1" />
                  </div>

                  {/* L√ìGICA DE FILTRADO REVISADA Y CORRECTA */}
                  {agendaItems.filter(item => {
                    const expired = isExpired(item.date); // Tarea vencida?

                    if (agendaTab === 'archived') {
                        // Muestra si est√° archivada manualmente O si ya venci√≥ (autom√°tica)
                        return item.archived || (item.status !== 'draft' && expired);
                    }
                    if (agendaTab === 'draft') {
                        return item.status === 'draft' && !item.archived;
                    }
                    // Published: No archivada manual Y no vencida
                    return item.status !== 'draft' && !item.archived && !expired;

                  }).filter(item => {
                    let show = true;
                    if (agendaFilterGrade && item.gradeLevel !== agendaFilterGrade) show = false;
                    if (agendaFilterArea && item.area !== agendaFilterArea) show = false;
                    if (agendaFilterDate && item.date !== agendaFilterDate) show = false;
                    return show;
                  }).map(item => (
                    <div key={item.id} className={`earth-card p-5 border-l-[6px] ${item.archived || isExpired(item.date) ? 'border-l-stone-400 bg-stone-100 opacity-70' : 'border-l-[#facc15]'}`}>
                      <div className="flex justify-between items-start mb-2">
                        <div className="flex flex-wrap gap-1">
                            <span className="text-[8px] font-black bg-stone-900 text-white px-2 py-0.5 rounded uppercase">{item.gradeLevel}</span>
                            <span className="text-[8px] font-black bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded uppercase">{item.area}</span>
                            {/* ICONOS DRIVE Y YOUTUBE REFORZADOS */}
                            {item.videoLink && <span className="text-[8px] font-black bg-red-100 text-red-600 px-1.5 py-0.5 rounded flex items-center gap-1"><VideoIcon size={8}/> VIDEO</span>}
                            {item.pdfLink && <span className="text-[8px] font-black bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded flex items-center gap-1"><FileText size={8}/> DRIVE</span>}
                        </div>
                        <span className="text-[10px] font-black text-[#064e3b]">{item.date}</span>
                      </div>
                      
                      {item.publishAt && new Date(item.publishAt) > new Date() && (
                          <div className="bg-blue-50 text-blue-700 text-[9px] font-black px-2 py-1 rounded-lg mb-2 inline-flex items-center gap-1 border border-blue-200">
                              <span>üïí Programada: {new Date(item.publishAt).toLocaleString()}</span>
                          </div>
                      )}

                      <h3 className="font-extrabold text-stone-900 text-sm uppercase">{item.title}</h3>
                      <div className="flex justify-end gap-2 mt-4 pt-4 border-t border-stone-100">
                        {/* L√ìGICA DE BOTONES INTELIGENTE */}
                        {item.status === 'draft' ? (
                            <button onClick={()=>publishDraft(item)} disabled={isSaving} className="p-2 text-blue-600 bg-blue-50 rounded-lg" title="Publicar Borrador"><Send size={20}/></button>
                        ) : (
                            item.archived || isExpired(item.date) ? (
                                <button onClick={()=>republishTask(item)} disabled={isSaving} className="p-2 text-emerald-600 bg-emerald-50 rounded-lg" title="Republicar"><RestoreIcon size={20}/></button>
                            ) : (
                                <button onClick={()=>archiveTask(item)} disabled={isSaving} className="p-2 text-stone-400" title="Archivar"><ArchiveIcon size={20}/></button>
                            )
                        )}
                        
                        <button onClick={()=>setEditingTask(item)} className="p-2 text-stone-400"><EditIcon size={20}/></button>
                        <button onClick={async ()=>{ if((await Swal.fire({title:'¬øEliminar?', icon:'warning', showCancelButton:true})).isConfirmed) db.collection("agendaEscolar").doc(item.id).delete(); }} className="p-2 text-stone-400"><TrashIcon size={20}/></button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {view === 'records' && (
              <div className="space-y-6">
                <div className="earth-card p-4 space-y-3 bg-stone-50">
                  <div className="grid grid-cols-2 gap-2">
                    <select value={filterGrade} onChange={e=>{setFilterGrade(e.target.value); setFilterStudent('');}} className="p-3 text-xs font-black">{gradeLevels.map(g => <option key={g} value={g}>{g}</option>)}</select>
                    
                    {/* MODIFICACI√ìN: SELECTOR DE √ÅREA CON OPCI√ìN "SIN √ÅREA" */}
                    <select value={filterArea} onChange={e=>setFilterArea(e.target.value)} className="p-3 text-xs font-black">
                        <option value="">Seleccionar √Årea...</option>
                        <option value="SIN_AREA">‚ö†Ô∏è SIN √ÅREA (ERRORES/HU√âRFANOS)</option>
                        {areasList.map(a => <option key={a} value={a}>{a}</option>)}
                    </select>
                    {/* --------------------------------------------------- */}

                  </div>
                  <select value={filterStudent} onChange={e=>setFilterStudent(e.target.value)} className="w-full p-3 text-xs font-black"><option value="">Todos los Estudiantes...</option>{(studentLists[filterGrade] || []).map(name => <option key={name.split(' - ')[1]} value={name.split(' - ')[1]}>{name.split(' - ')[0]}</option>)}</select>
                  <select value={filterActivity} onChange={e=>setFilterActivity(e.target.value)} className="w-full p-3 text-xs font-black"><option value="">Todas las Actividades...</option>{currentActivities.map(act => <option key={act} value={act}>{act}</option>)}</select>
                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={generateReportPDF} className="p-4 bg-[#064e3b] text-[#facc15] font-black text-[10px] uppercase rounded-xl flex items-center justify-center gap-2 shadow-lg active:scale-95"><FileText size={16}/> DESCARGAR PDF</button>
                    <button onClick={generateObservationsPDF} className="p-4 bg-stone-700 text-white font-black text-[10px] uppercase rounded-xl flex items-center justify-center gap-2 shadow-lg active:scale-95"><FileText size={16}/> PDF OBS./ALERTAS</button>
                    
                    <button onClick={generateStudentReportPDF} className="p-4 bg-blue-800 text-white font-black text-[10px] uppercase rounded-xl flex items-center justify-center gap-2 shadow-lg active:scale-95 col-span-2 md:col-span-1"><FileText size={16}/> PDF ESTUDIANTE</button>
                    
                    <button onClick={async ()=>{ if(!filterActivity) return; if((await Swal.fire({title:'¬øBorrar Actividad?', icon:'warning', showCancelButton:true})).isConfirmed){ const b = db.batch(); filteredRecords.forEach(r => b.delete(db.collection("notasAcademicas").doc(r.id))); await b.commit(); setFilterActivity(''); } }} className="p-4 bg-red-800 text-white font-black text-[10px] uppercase rounded-xl shadow-lg active:scale-95">BORRAR ACTIVIDAD</button>
                  </div>
                </div>
                <div className="overflow-x-auto"><table className="table-earth">
                  <thead><tr><th>Estudiante</th><th className="text-center">Nota</th><th className="text-right">Acci√≥n</th></tr></thead>
                  <tbody>{filteredRecords.map(s => (
                    <tr key={s.id}>
                      <td><p className="text-xs font-black">{s.nombreEstudiante}</p><p className="text-[9px] text-stone-400">{s.actividad}</p></td>
                      <td className="text-center font-black text-lg">
                        {(s.score||'0').replace('.',',')}
                        {s.recuperada && <span className="block text-[8px] text-red-600 font-bold">(Recuper√≥)</span>}
                      </td>
                      <td className="text-right flex justify-end gap-1">
                        <button onClick={()=>setEditingGradeEntry({...s, originalNota: parseFloat(s.score.replace(',','.'))})} className="p-2 bg-stone-100 rounded-lg"><EditIcon size={14}/></button>
                        <button onClick={()=>deleteSingleGrade(s.id)} className="p-2 bg-red-50 text-red-500 rounded-lg"><TrashIcon size={14}/></button>
                      </td>
                    </tr>
                  ))}</tbody>
                </table></div>
              </div>
            )}

            {view === 'mailbox' && (
              <div className="space-y-4">
                <div className="flex gap-2 mb-2 bg-stone-100 p-1 rounded-2xl">
                    <button onClick={()=>setMailboxTab('active')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-xl ${mailboxTab==='active'?'bg-[#064e3b] text-[#facc15] shadow-md':'text-stone-400'}`}>Recibidos</button>
                    <button onClick={()=>setMailboxTab('archived')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-xl ${mailboxTab==='archived'?'bg-[#064e3b] text-[#facc15] shadow-md':'text-stone-400'}`}>Archivados</button>
                </div>
                {inboxMessages.filter(m => mailboxTab === 'active' ? !m.archived : m.archived).map(m => (
                  <div key={m.id} className={`earth-card p-5 border-r-[6px] ${m.archived ? 'border-r-stone-400 bg-stone-50' : 'border-r-[#facc15]'}`}>
                    <div className="mb-2 flex justify-between">
                        <div><p className="text-[10px] font-black text-[#064e3b] uppercase">{m.studentName}</p><p className="text-[9px] font-bold text-stone-400">{m.taskTitle}</p></div>
                        <div className="flex gap-1">
                            {!m.archived ? <button onClick={async ()=>await db.collection("mensajesAgenda").doc(m.id).update({ archived: true })} className="p-2 bg-stone-100 rounded-lg"><ArchiveIcon size={14}/></button> : <button onClick={async ()=>await db.collection("mensajesAgenda").doc(m.id).update({ archived: false })} className="p-2 bg-emerald-100 text-emerald-700 rounded-lg"><RestoreIcon size={14}/></button>}
                            <button onClick={async ()=>{ if((await Swal.fire({title:'¬øEliminar?', icon:'warning', showCancelButton:true})).isConfirmed) await db.collection("mensajesAgenda").doc(m.id).delete(); }} className="p-2 bg-red-50 text-red-400 rounded-lg"><TrashIcon size={14}/></button>
                        </div>
                    </div>
                    <div className="flex flex-col gap-2 mb-4">{m.conversacion && m.conversacion.map((chat, idx) => (<div key={idx} className={`chat-bubble ${chat.rol === 'docente' ? 'docente' : 'user'}`}>{chat.texto}</div>))}</div>
                    <div className="flex gap-2">
                      <input type="text" placeholder="Responder..." value={replyText[m.id]||''} onChange={e=>setReplyText({...replyText,[m.id]:e.target.value})} className="flex-1 px-4 text-xs font-black"/>
                      <button onClick={async () => {
                        await db.collection("mensajesAgenda").doc(m.id).update({ conversacion: firebase.firestore.FieldValue.arrayUnion({ rol: 'docente', texto: replyText[m.id], timestamp: new Date().toISOString() }), read: true });
                        setReplyText({...replyText, [m.id]: ''});
                      }} className="bg-[#064e3b] text-[#facc15] p-4 rounded-xl"><Send size={18}/></button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 pb-8 flex items-center justify-between shadow-2xl z-50">
            <button onClick={()=>setView('recent')} className={`flex flex-col items-center gap-1 ${view==='recent'?'nav-active':'text-stone-400'}`}><Home size={22}/><span className="text-[8px] uppercase">Inicio</span></button>
            <button onClick={()=>setView('agenda')} className={`flex flex-col items-center gap-1 ${view==='agenda'?'nav-active':'text-stone-400'}`}><Book size={22}/><span className="text-[8px] uppercase">Agenda</span></button>
            <div className="-mt-14"><button onClick={()=>setIsFormOpen(true)} className="h-16 w-16 rounded-2xl bg-[#064e3b] text-[#facc15] flex items-center justify-center shadow-2xl active:scale-90"><Plus size={32}/></button></div>
            <button onClick={()=>setView('records')} className={`flex flex-col items-center gap-1 ${view==='records'?'nav-active':'text-stone-400'}`}><Database size={22}/><span className="text-[8px] uppercase">Registros</span></button>
            <button onClick={()=>setView('mailbox')} className={`flex flex-col items-center gap-1 ${view==='mailbox'?'nav-active':'text-stone-400'}`}><MessageCircle size={22}/><span className="text-[8px] uppercase">Buz√≥n</span></button>
          </nav>

          {/* CONFIGURACI√ìN */}
          {isConfigOpen && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-stone-900/80 backdrop-blur-sm" onClick={()=>setIsConfigOpen(false)} />
              <div className="relative bg-white w-full max-w-md rounded-[32px] overflow-hidden flex flex-col border-t-8 border-[#064e3b]">
                <div className="p-8 border-b flex justify-between items-center"><h2 className="text-xl font-black text-[#064e3b] uppercase">Configuraci√≥n</h2><button onClick={()=>setIsConfigOpen(false)}>‚úï</button></div>
                <div className="p-8 space-y-8">
                  <div className="grid grid-cols-4 gap-2">{[1,2,3,4].map(p => <button key={p} onClick={() => updateGlobalPeriod(p)} className={`py-4 rounded-2xl font-black ${periodoActual === p ? 'bg-[#064e3b] text-[#facc15]' : 'bg-stone-100 text-stone-400'}`}>P{p}</button>)}</div>
                </div>
              </div>
            </div>
          )}

          {/* MODAL PERI√ìDICO (AJUSTADO QUIR√öRGICAMENTE) */}
          {isBoardOpen && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-stone-900/80 backdrop-blur-sm" onClick={()=>setIsBoardOpen(false)} />
              <div className="relative bg-white w-full max-w-lg rounded-[32px] overflow-hidden flex flex-col border-t-8 border-[#064e3b] max-h-[85vh]">
                <div className="p-6 border-b flex justify-between items-center"><h2 className="text-xl font-black text-[#064e3b] uppercase tracking-tighter">Gesti√≥n Peri√≥dico</h2><button onClick={()=>setIsBoardOpen(false)}>‚úï</button></div>
                
                {/* AQUI EST√Å EL ID QUE ARREGLA EL SCROLL */}
                <div id="board-scroll-container" class="p-6 space-y-4 overflow-y-auto no-scrollbar flex-1">
                    
                    {/* BARRA DE SE√ëALES R√ÅPIDAS (NUEVO) */}
                    <div className="flex flex-wrap gap-2 mb-1">
                        <button onClick={() => setNoticeText(prev => "üö® ¬°IMPORTANTE! " + prev)} className="px-2 py-1 bg-red-100 text-red-700 rounded-lg text-[9px] font-black border border-red-200">üö® IMPORTANTE</button>
                        <button onClick={() => setNoticeText(prev => "üí° TENER EN CUENTA: " + prev)} className="px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-[9px] font-black border border-blue-200">üí° RECORDATORIO</button>
                        <button onClick={() => setNoticeText(prev => "‚ú® ¬°√ÅNIMO! " + prev)} className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-[9px] font-black border border-yellow-200">‚ú® √ÅNIMO</button>
                        <button onClick={() => setNoticeText(prev => "üì¢ AVISO: " + prev)} className="px-2 py-1 bg-green-100 text-green-700 rounded-lg text-[9px] font-black border border-green-200">üì¢ AVISO</button>
                        {/* BOTONES NUEVOS */}
                        <button onClick={() => setNoticeText(prev => "üî• URGENTE: " + prev)} className="px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-[9px] font-black border border-orange-200">üî• URGENTE</button>
                        <button onClick={() => setNoticeText(prev => "‚≠ê IMPORTANTE: " + prev)} className="px-2 py-1 bg-purple-100 text-purple-700 rounded-lg text-[9px] font-black border border-purple-200">‚≠ê IMPORTANTE</button>
                        <button onClick={() => setNoticeText(prev => "üß† NO OLVIDAR: " + prev)} className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-[9px] font-black border border-indigo-200">üß† NO OLVIDAR</button>
                    </div>

                    <textarea value={noticeText} onChange={e=>setNoticeText(e.target.value)} className="w-full p-3 text-xs font-bold border border-stone-300 rounded-xl resize-none h-20" placeholder="Escribe el aviso..."></textarea>
                    <input type="url" value={noticeVideo} onChange={e=>setNoticeVideo(e.target.value)} className="w-full p-2 text-[10px] border rounded-lg" placeholder="YouTube URL"/>
                    <label className="block bg-white p-2 rounded-lg border border-dashed border-stone-400 text-[10px] font-black text-center cursor-pointer">
                        {noticeImage ? "üì∑ FOTO CARGADA" : "üì∑ SUBIR FOTO"}<input type="file" accept="image/*" onChange={handleFileChange} className="hidden"/>
                    </label>
                    
                    <div className="space-y-3 p-3 bg-stone-100 rounded-2xl">
                        {/* PESTA√ëAS DEL TABLERO */}
                        <div className="flex gap-2 bg-white p-1 rounded-xl shadow-sm mb-2">
                            <button onClick={()=>setNoticeTab('active')} className={`flex-1 py-2 text-[10px] font-black rounded-lg ${noticeTab==='active'?'bg-[#064e3b] text-white':'text-stone-400'}`}>ACTIVOS</button>
                            <button onClick={()=>setNoticeTab('archived')} className={`flex-1 py-2 text-[10px] font-black rounded-lg ${noticeTab==='archived'?'bg-[#064e3b] text-white':'text-stone-400'}`}>ARCHIVADOS</button>
                        </div>
                    
                        <div className="flex gap-2 bg-white p-1 rounded-xl shadow-sm">
                            {['General', 'Grado', 'Individual'].map(s => (
                                <button key={s} onClick={()=>setNoticeScope(s)} className={`flex-1 py-2 text-[10px] font-black rounded-lg transition-all ${noticeScope===s?'bg-[#064e3b] text-white':'text-stone-400'}`}>{s}</button>
                            ))}
                        </div>
                        {noticeScope === 'Grado' && (
                            <div className="flex flex-wrap gap-1">{gradeLevels.map(g => (
                                <button key={g} onClick={()=>toggleNoticeTarget(g)} className={`px-2 py-1 rounded text-[10px] font-black border ${noticeTargets.includes(g) ? 'bg-emerald-600 text-white' : 'bg-white text-stone-400'}`}>{g}</button>
                            ))}</div>
                        )}
                        {noticeScope === 'Individual' && (
                            <select value={targetStudentDoc} onChange={e=>setTargetStudentDoc(e.target.value)} className="w-full p-2 text-[10px] font-black bg-white rounded-lg border border-stone-300">
                                <option value="">Seleccionar Estudiante...</option>
                                {Object.values(studentLists).flat().map(student => {
                                    const [name, doc] = student.split(' - ');
                                    return <option key={doc} value={doc}>{name}</option>
                                })}
                            </select>
                        )}
                    </div>
                    
                    {/* SECCI√ìN QUIR√öRGICA: FECHAS */}
                    <div className="grid grid-cols-2 gap-2 mt-2">
                        <div className="bg-stone-50 p-2 rounded-xl border border-stone-200">
                            <label className="block text-[8px] font-black text-stone-500 uppercase">Publicar</label>
                            <input type="datetime-local" value={noticePublishAt} onChange={e=>setNoticePublishAt(e.target.value)} className="w-full text-[9px] font-black bg-transparent border-none p-0 focus:ring-0"/>
                        </div>
                        <div className="bg-stone-50 p-2 rounded-xl border border-stone-200">
                            <label className="block text-[8px] font-black text-stone-500 uppercase">Expirar/Eliminar</label>
                            <input type="datetime-local" value={noticeExpiresAt} onChange={e=>setNoticeExpiresAt(e.target.value)} className="w-full text-[9px] font-black bg-transparent border-none p-0 focus:ring-0"/>
                        </div>
                    </div>

                    <div className="flex gap-2 mt-2">
                        <select value={noticeColor} onChange={e=>setNoticeColor(e.target.value)} className="p-2 text-xs font-black rounded-xl border border-stone-300 flex-1">
                            <option value="yellow">Amarillo</option><option value="pink">Rosado</option><option value="blue">Azul</option><option value="green">Verde</option>
                            {/* NUEVOS COLORES */}
                            <option value="orange">Naranja</option>
                            <option value="purple">Lavanda</option>
                            <option value="teal">Turquesa</option>
                            <option value="lime">Lima</option>
                            <option value="white">Blanco</option>
                            <option value="brown">Kraft</option>
                        </select>
                        <button onClick={handlePublishNotice} className="flex-[2] bg-[#064e3b] text-[#facc15] font-black text-[10px] uppercase rounded-xl shadow-lg">{editingNoticeId ? 'GUARDAR CAMBIOS' : 'PUBLICAR'}</button>
                    </div>

                    <div className="space-y-2 mt-4">
                        {noticesList.filter(n => noticeTab === 'active' ? !n.archived : n.archived).map(n => (
                            <div key={n.id} className="flex justify-between items-center p-3 rounded-xl border bg-white border-stone-200">
                                <p className="text-[10px] font-black text-stone-700 truncate flex-1">{n.mensaje}</p>
                                <div className="flex gap-1">
                                    {noticeTab === 'active' && <button onClick={()=>prepareEditNotice(n)} className="p-1.5 text-blue-600"><EditIcon size={14}/></button>}
                                    <button onClick={()=>archiveNotice(n)} className="p-1.5 text-stone-500">
                                        {noticeTab === 'active' ? <ArchiveIcon size={14}/> : <RestoreIcon size={14}/>}
                                    </button>
                                    <button onClick={()=>deleteNotice(n.id)} className="p-1.5 text-red-500"><TrashIcon size={14}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
              </div>
            </div>
          )}

          {/* MODAL AGREGAR NOTAS (RESTAURADO COMPLETO CON OBSERVACI√ìN) */}
          {isFormOpen && (
            <div className="fixed inset-0 z-[100] flex items-end justify-center">
              <div className="absolute inset-0 bg-stone-900/60 backdrop-blur-md" onClick={()=>setIsFormOpen(false)} />
              <div className="relative bg-white w-full max-w-lg h-[85vh] rounded-t-[40px] shadow-2xl flex flex-col border-t-8 border-[#064e3b] overflow-hidden">
                <div className="p-8 border-b flex justify-between items-center"><h2 className="text-xl font-black text-stone-900 uppercase">Notas P{periodoActual}</h2><button onClick={()=>setIsFormOpen(false)}>‚úï</button></div>
                <div className="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar">
                  <input type="text" name="actividad" placeholder="Actividad..." value={batchData.actividad} onChange={handleBatchConfigChange} className="w-full text-lg font-black border-b-2 pb-2 outline-none"/>
                  <div className="grid grid-cols-2 gap-3">
                    <select name="gradeLevel" value={batchData.gradeLevel} onChange={handleBatchConfigChange} className="p-4 text-xs font-black"><option value="">Grado...</option>{gradeLevels.map(g=><option key={g} value={g}>{g}</option>)}</select>
                    <select name="area" value={batchData.area} onChange={handleBatchConfigChange} className="p-4 text-xs font-black"><option value="">√Årea...</option>{areasList.map(a=><option key={a} value={a}>{a}</option>)}</select>
                  </div>
                  {batchData.entries.map((en, idx) => (
                    <div key={idx} className={`p-4 rounded-2xl border-2 ${en.saved ? 'border-emerald-500 bg-emerald-50' : 'border-stone-200'} space-y-3`}>
                      <div className="flex justify-between items-start gap-4">
                        <div className="flex-1">
                            <span className="text-[11px] font-black text-stone-900 uppercase block mb-2">{en.name.split(' - ')[0]}</span>
                            <textarea placeholder="Observaciones..." value={en.observation} onChange={e => {const newEntries = [...batchData.entries]; newEntries[idx].observation = e.target.value; setBatchData({...batchData, entries: newEntries});}} className="w-full h-16 p-2 text-[10px] font-bold resize-none border rounded-lg"/>
                        </div>
                        <div className="flex flex-col gap-2 items-center">
                            <input type="text" placeholder="0.0" value={en.score} onChange={e => {const newEntries = [...batchData.entries]; newEntries[idx].score = e.target.value.replace(/,/g, '.'); setBatchData({...batchData, entries: newEntries});}} className="w-16 h-12 text-center bg-white border-2 border-stone-400 rounded-xl font-black text-xl"/>
                            <button onClick={() => saveIndividualGrade(en, idx)} disabled={isSaving} className={`p-3 rounded-xl shadow-md ${en.saved ? 'bg-emerald-600 text-white' : 'bg-[#facc15] text-[#064e3b]'}`}><SaveIcon size={18} /></button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="p-8 border-t"><button onClick={saveGrades} disabled={isSaving} className="w-full bg-[#064e3b] text-[#facc15] py-5 rounded-2xl font-black uppercase shadow-lg">Guardar Todo el Grupo</button></div>
              </div>
            </div>
          )}

          {/* EDITING MODALS (Restaurados) */}
          {editingTask && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-stone-900/80" onClick={()=>setEditingTask(null)} />
              <div className="relative bg-white w-full max-w-md rounded-[40px] p-6 border-t-[10px] border-[#facc15] max-h-[90vh] overflow-y-auto no-scrollbar">
                <h3 className="font-black mb-4 uppercase text-emerald-900">Editar Tarea Completa</h3>
                <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-2">
                        <div>
                            <label className="text-[9px] font-black text-stone-400 uppercase">√Årea</label>
                            <select value={editingTask.area} onChange={e=>setEditingTask({...editingTask, area:e.target.value})} className="w-full p-3 text-xs font-black">
                                {areasList.map(a => <option key={a} value={a}>{a}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="text-[9px] font-black text-stone-400 uppercase">Fecha Entrega</label>
                            <input type="date" value={editingTask.date} onChange={e=>setEditingTask({...editingTask, date:e.target.value})} className="w-full p-3 text-xs font-black"/>
                        </div>
                    </div>
                    <div>
                        <label className="text-[9px] font-black text-stone-400 uppercase">T√≠tulo de la Actividad</label>
                        <input type="text" value={editingTask.title} onChange={e=>setEditingTask({...editingTask, title:e.target.value})} className="w-full p-3 text-xs font-black"/>
                    </div>
                    <div>
                        <label className="text-[9px] font-black text-stone-400 uppercase">YouTube Link</label>
                        <input type="url" value={editingTask.videoLink || ''} onChange={e=>setEditingTask({...editingTask, videoLink:e.target.value})} className="w-full p-3 text-[10px] font-black bg-stone-50"/>
                    </div>
                    <div>
                        <label className="text-[9px] font-black text-stone-400 uppercase">Drive/PDF Link</label>
                        <input type="url" value={editingTask.pdfLink || ''} onChange={e=>setEditingTask({...editingTask, pdfLink:e.target.value})} className="w-full p-3 text-[10px] font-black bg-stone-50"/>
                    </div>
                    <div>
                        <label className="text-[9px] font-black text-stone-400 uppercase">Descripci√≥n / Instrucciones</label>
                        <textarea value={editingTask.description} onChange={e=>setEditingTask({...editingTask, description:e.target.value})} className="w-full p-3 text-xs font-bold h-32 resize-none"></textarea>
                    </div>
                </div>
                <div className="flex gap-2 mt-6">
                    <button onClick={()=>setEditingTask(null)} className="flex-1 py-4 bg-stone-200 rounded-2xl font-black uppercase text-xs">Cancelar</button>
                    <button onClick={async ()=>{ await db.collection("agendaEscolar").doc(editingTask.id).update(editingTask); setEditingTask(null); Swal.fire({icon:'success', title:'Tarea Actualizada', toast:true, position:'top-end', timer:1500, showConfirmButton:false}); }} className="flex-[2] py-4 bg-emerald-900 text-[#facc15] rounded-2xl font-black uppercase text-xs shadow-lg">Guardar Cambios</button>
                </div>
              </div>
            </div>
          )}

          {/* MODAL NOTA INDIVIDUAL (CON ALERTA EN EDICI√ìN) */}
          {editingGradeEntry && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-stone-900/70" onClick={()=>setEditingGradeEntry(null)} />
              <div className="relative bg-white w-full max-w-md rounded-[40px] p-6 border-t-[10px] border-[#facc15]">
                <h3 className="font-black mb-4 uppercase">{editingGradeEntry.nombreEstudiante}</h3>
                
                {/* CAMBIO 1: EDITAR NOMBRE ACTIVIDAD */}
                <input type="text" value={editingGradeEntry.actividad} onChange={e=>setEditingGradeEntry({...editingGradeEntry, actividad: e.target.value})} className="w-full p-3 mb-3 border-b-2 border-stone-200 font-bold text-center outline-none" placeholder="Nombre de la Actividad"/>
                
                <input type="text" value={editingGradeEntry.score} onChange={e=>setEditingGradeEntry({...editingGradeEntry, score: e.target.value.replace(/,/g, '.')})} className="w-full p-5 text-3xl text-center font-black border-2 border-[#064e3b] rounded-2xl mb-4"/>
                <textarea value={editingGradeEntry.observacion || ''} onChange={e=>setEditingGradeEntry({...editingGradeEntry, observacion: e.target.value})} className="w-full p-3 border-2 border-stone-200 rounded-2xl mb-4 h-24 resize-none" placeholder="Editar observaci√≥n..."></textarea>
                
                <button onClick={async ()=>{ 
                    // L√ìGICA DE RECUPERACI√ìN + ALERTA EN EDICI√ìN
                    const newNota = parseFloat(editingGradeEntry.score.replace(',','.'));
                    const isJustRecovered = editingGradeEntry.originalNota < 3 && newNota >= 3;
                    const isRecovery = isJustRecovered || editingGradeEntry.recuperada;

                    const updateData = {
                        actividad: editingGradeEntry.actividad,
                        score: editingGradeEntry.score,
                        nota: newNota,
                        observacion: editingGradeEntry.observacion || '',
                        recuperada: isRecovery
                    };

                    if(isJustRecovered) {
                        updateData.notaAnterior = editingGradeEntry.originalNota;
                    }

                    await db.collection("notasAcademicas").doc(editingGradeEntry.id).update(updateData);

                    // --- NUEVA L√ìGICA QUIR√öRGICA: ALERTA AL EDITAR SI BAJA DE 3.0 ---
                    if (newNota < 3.0) {
                        await db.collection("tableroAvisos").add({
                            mensaje: `‚ö†Ô∏è ALERTA ACAD√âMICA\nEl estudiante presenta desempe√±o bajo.\n\nüìö √ÅREA: ${editingGradeEntry.area}\nüìù ACTIVIDAD: ${editingGradeEntry.actividad}\nüìâ NOTA: ${newNota}\n\nPor favor revisar la secci√≥n de Alertas dentro de Pizarra Escolar para ampliar la informaci√≥n.`,
                            color: 'red',
                            imageUrl: "https://cdn-icons-png.flaticon.com/512/564/564619.png", // IMAGEN ESTABLE
                            videoUrl: "",
                            scope: 'Individual',
                            targetGrades: [],
                            targetStudentDoc: editingGradeEntry.documentoEstudiante,
                            fecha: new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' }),
                            timestamp: new Date().toISOString(),
                            archived: false,
                            likes: [],
                            isSystemNotice: false 
                        });
                    }
                    // ----------------------------------------------------------------

                    setEditingGradeEntry(null); 
                }} className="w-full py-4 bg-[#064e3b] text-[#facc15] rounded-2xl font-black uppercase">Actualizar Nota y Observaci√≥n</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
