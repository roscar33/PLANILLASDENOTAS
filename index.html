<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Seguimiento Académico - Clase 9218</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    .animate-slide-up { animation: slideUp 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  </style>
</head>

<body class="bg-slate-50 touch-manipulation text-slate-800 font-sans selection:bg-lime-200">
  <div id="root"></div>

  <!-- =========================
       FIREBASE (Module)
       ========================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc, setDoc, getDoc,
      collection, query, orderBy,
      onSnapshot,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d",
      storageBucket: "diariodeprocesos-6f78d.firebasestorage.app",
      messagingSenderId: "487922338632",
      appId: "1:487922338632:web:5b65cbb4a1d630a2b0817d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Puente hacia React
    window.__fb = {
      app, auth, db,
      doc, setDoc, getDoc,
      collection, query, orderBy,
      onSnapshot,
      deleteDoc,
      uid: null,
      status: "connecting", 
      error: null,
      _listeners: new Set(),
      notify() {
        for (const fn of window.__fb._listeners) {
          try { fn({ status: window.__fb.status, error: window.__fb.error, uid: window.__fb.uid }); } catch {}
        }
      },
      onStatus(fn) {
        window.__fb._listeners.add(fn);
        fn({ status: window.__fb.status, error: window.__fb.error, uid: window.__fb.uid });
        return () => window.__fb._listeners.delete(fn);
      }
    };

    // Inicialización de Auth
    window.firebaseReady = new Promise(async (resolve) => {
      try {
        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            await signInAnonymously(auth);
            return; 
          }
          window.__fb.uid = user.uid;
          window.__fb.status = "ready";
          window.__fb.notify();
          resolve({ uid: user.uid, db });
        });
      } catch (e) {
        window.__fb.status = "error";
        window.__fb.error = e?.message || String(e);
        window.__fb.notify();
        resolve({ uid: null, db });
      }
    });
  </script>

  <!-- =========================
       REACT APP
       ========================= -->
  <script type="text/babel">
    // --- ÍCONOS (Lucide Simplificado) ---
    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={className}>{children}</svg>
    );
    const Plus = (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
    const Trash2 = (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
    const GraduationCap = (p) => <Icon {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></Icon>;
    const Save = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
    const X = (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 18 12"/></Icon>;
    const BookOpen = (p) => <Icon {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Icon>;
    const Layers = (p) => <Icon {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></Icon>;
    const Users = (p) => <Icon {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
    const FileSpreadsheet = (p) => <Icon {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></Icon>;
    const Download = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
    const AlertTriangle = (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></Icon>;
    const AlertCircle = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>;
    const Edit2 = (p) => <Icon {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
    const Filter = (p) => <Icon {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>;
    const Settings = (p) => <Icon {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Icon>;
    const Cloud = (p) => <Icon {...p}><path d="M20 17.5a4.5 4.5 0 0 0-1-8.9 6 6 0 0 0-11.7 1.6A4 4 0 0 0 8 20h10a3 3 0 0 0 2-2.5Z"/></Icon>;
    const KeyRound = (p) => <Icon {...p}><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></Icon>;

    const { useState, useEffect, useMemo } = React;

    // --- HELPERS DECIMAL ---
    const formatDisplay = (val) => {
      if (val === '' || val === null || val === undefined) return '';
      if (typeof val === 'string' && val.includes(',')) return val;
      const num = parseFloat(val);
      if (isNaN(num)) return val;
      return num.toString().replace('.', ',');
    };
    const parseInput = (val) => (val ?? '').toString().replace(',', '.');

    const validateScoreInput = (value) => {
      if (value === '') return true;
      const regex = /^[0-9]*[.,]?[0-9]*$/;
      if (!regex.test(value)) return false;
      const numVal = parseFloat(value.replace(',', '.'));
      if (!isNaN(numVal)) return numVal >= 0 && numVal <= 5.0;
      return true;
    };

    // --- APP PRINCIPAL ---
    const App = () => {
      // ----------------------------------------------------
      // AQUÍ ESTÁ LA CLAVE 9218 CONFIGURADA FIJA
      // ----------------------------------------------------
      const syncId = "9218";
      
      const [fbStatus, setFbStatus] = useState({ status: "connecting", error: null });

      return <Dashboard syncId={syncId} fbStatus={fbStatus} setFbStatus={setFbStatus} />;
    };

    // --- DASHBOARD (Lógica de notas) ---
    const Dashboard = ({ syncId, fbStatus, setFbStatus }) => {
      const [students, setStudents] = useState([]);
      const [studentLists, setStudentLists] = useState({
        'Quinto': [], 'Primero': [], 'Segundo': [], 'Tercero': [], 'Cuarto': []
      });

      // Vistas
      const [view, setView] = useState('recent');
      const [isFormOpen, setIsFormOpen] = useState(false);
      const [isReportOpen, setIsReportOpen] = useState(false);
      const [isConfigOpen, setIsConfigOpen] = useState(false);

      // Filtros
      const [topicFilter, setTopicFilter] = useState({ gradeLevel: '', area: '' });
      const [editingTopic, setEditingTopic] = useState(null);

      // Formulario
      const [batchData, setBatchData] = useState({ gradeLevel: '', area: '', globalConcept: '', entries: [] });
      const [error, setError] = useState('');

      // Config estudiantes
      const [configGrade, setConfigGrade] = useState('Quinto');
      const [newStudentName, setNewStudentName] = useState('');

      // Reportes
      const [reportFilter, setReportFilter] = useState({ gradeLevel: 'Quinto', area: 'MATEMATICAS' });

      // Constantes
      const gradeLevels = ['Primero', 'Segundo', 'Tercero', 'Cuarto', 'Quinto'];
      const areas = [
        'INGLES', 'CIENCIAS NATURALES', 'CIENCIAS SOCIALES', 'ARTISTICA', 
        'EDUCACION FISICA', 'ETICA Y VALORES', 'RELIGION', 'ESPAÑOL (LENGUAJE)', 
        'MATEMATICAS', 'TECNOLOGIA E INFORMATICA'
      ];

      // =========================
      // FIREBASE SYNC (CORE)
      // =========================
      useEffect(() => {
        if (!window.__fb || !syncId) return;
        const off = window.__fb.onStatus((s) => setFbStatus({ status: s.status, error: s.error }));

        let unsubRecords = null;
        let unsubLists = null;

        (async () => {
          await window.firebaseReady;
          const { db, collection, query, orderBy, onSnapshot, doc, getDoc, setDoc } = window.__fb;

          // 1) Escuchar RECORDS en la carpeta de la clave 9218
          const recordsRef = collection(db, 'classes', syncId, 'records');
          const q = query(recordsRef, orderBy('createdAt', 'desc'));
          
          unsubRecords = onSnapshot(q, (snap) => {
            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            setStudents(data);
          }, (err) => {
            console.error(err);
            setFbStatus({ status: "error", error: "Error de permisos o red" });
          });

          // 2) Escuchar LISTAS DE ESTUDIANTES
          const listsRef = doc(db, 'classes', syncId, 'config', 'studentLists');
          unsubLists = onSnapshot(listsRef, (snap) => {
            if (snap.exists()) {
              setStudentLists(snap.data()?.lists || {});
            }
          });

          // Crear doc inicial de listas si no existe
          try {
            const docSnap = await getDoc(listsRef);
            if (!docSnap.exists()) {
              await setDoc(listsRef, { lists: studentLists, updatedAt: Date.now() });
            }
          } catch(e) { console.log("Init list error", e); }
        })();

        return () => {
          try { off && off(); } catch {}
          try { unsubRecords && unsubRecords(); } catch {}
          try { unsubLists && unsubLists(); } catch {}
        };
      }, [syncId]);

      // Guardar listas en Firebase al modificar
      const saveListsToFirebase = async (newLists) => {
        setStudentLists(newLists);
        if (!window.__fb || !syncId) return;
        try {
          const { db, doc, setDoc } = window.__fb;
          const listsRef = doc(db, 'classes', syncId, 'config', 'studentLists');
          await setDoc(listsRef, { lists: newLists, updatedAt: Date.now() }, { merge: true });
        } catch (e) {
          console.error("Error saving lists", e);
        }
      };

      // --- HELPERS CRUD ---
      const writeRecord = async (record) => {
        const { db, doc, setDoc } = window.__fb;
        const ref = doc(db, 'classes', syncId, 'records', record.id);
        await setDoc(ref, record, { merge: true });
      };

      const removeRecord = async (recordId) => {
        const { db, doc, deleteDoc } = window.__fb;
        const ref = doc(db, 'classes', syncId, 'records', recordId);
        await deleteDoc(ref);
      };

      // --- LOGICA DE NEGOCIO ---
      
      const topics = useMemo(() => {
        const grouped = {};
        const relevant = students.filter(s => {
          if (view === 'topics' && topicFilter.gradeLevel && topicFilter.area) {
            return s.gradeLevel === topicFilter.gradeLevel && s.area === topicFilter.area;
          }
          return true;
        });
        relevant.forEach(s => {
          const key = `${s.gradeLevel}-${s.area}-${s.concept}`;
          if (!grouped[key]) {
            grouped[key] = {
              id: key,
              gradeLevel: s.gradeLevel,
              area: s.area,
              concept: s.concept,
              date: s.date || '',
              count: 0
            };
          }
          grouped[key].count++;
        });
        return Object.values(grouped).sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
      }, [students, view, topicFilter]);

      // Gestión estudiantes
      const addStudentToList = (e) => {
        e.preventDefault();
        if (!newStudentName.trim()) return;
        const updated = {
          ...studentLists,
          [configGrade]: [...(studentLists[configGrade] || []), newStudentName.trim()]
        };
        saveListsToFirebase(updated);
        setNewStudentName('');
      };

      const removeStudentFromList = (nameToRemove) => {
        if (confirm(`¿Eliminar a ${nameToRemove}?`)) {
          const updated = {
            ...studentLists,
            [configGrade]: studentLists[configGrade].filter(name => name !== nameToRemove)
          };
          saveListsToFirebase(updated);
        }
      };

      // Borrar Tema
      const deleteTopic = async (e, topic) => {
        e.stopPropagation();
        if (!confirm(`¿Borrar TODAS las notas de "${topic.concept}"?`)) return;
        const toDelete = students.filter(s => s.gradeLevel === topic.gradeLevel && s.area === topic.area && s.concept === topic.concept);
        for (const r of toDelete) await removeRecord(r.id);
      };

      // Guardar Lote
      const handleBatchConfigChange = (e) => {
        const { name, value } = e.target;
        setBatchData(prev => {
          const newData = { ...prev, [name]: value };
          if (name === 'gradeLevel') {
            const list = studentLists[value] || [];
            if (list.length > 0) {
              newData.entries = list.map(n => ({ name: n, score: '', individualConcept: '', observation: '' }));
            } else {
              newData.entries = [{ name: '', score: '', individualConcept: '', observation: '' }];
            }
          }
          return newData;
        });
      };

      const handleEntryChange = (index, field, value) => {
        const newEntries = [...batchData.entries];
        if (field === 'score') {
          if (validateScoreInput(value)) newEntries[index][field] = value;
        } else {
          newEntries[index][field] = value;
        }
        setBatchData(prev => ({ ...prev, entries: newEntries }));
      };

      const createRecord = (grade, area, name, score, conceptRaw, observation) => {
        const numScore = parseFloat(score);
        let finalConcept = conceptRaw;
        if (!finalConcept) {
          if (numScore >= 4.5) finalConcept = "Excelente desempeño";
          else if (numScore >= 4.0) finalConcept = "Buen trabajo";
          else if (numScore >= 3.0) finalConcept = "Aprobado básico";
          else finalConcept = "Necesita refuerzo";
        }
        return {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          gradeLevel: grade, area, name, score, 
          concept: finalConcept, observation: observation || '',
          date: new Date().toLocaleDateString('es-CO'), createdAt: Date.now()
        };
      };

      const handleSaveBatch = async () => {
        if (!batchData.gradeLevel || !batchData.area) { setError('Faltan datos básicos'); return; }
        const validEntries = batchData.entries.filter(en => en.name.trim() !== '' && en.score !== '');
        if (validEntries.length === 0) { setError('No hay notas válidas'); return; }

        try {
          for (const entry of validEntries) {
            const r = createRecord(batchData.gradeLevel, batchData.area, entry.name, parseInput(entry.score), entry.individualConcept || batchData.globalConcept, entry.observation);
            await writeRecord(r);
          }
          setIsFormOpen(false);
          setBatchData({ gradeLevel: '', area: '', globalConcept: '', entries: [] });
          setError('');
          Swal.fire({ icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false });
        } catch (e) {
          alert("Error guardando: " + e.message);
        }
      };

      // Edición Tema
      const openTopicEditor = (topic) => {
        const existing = students.filter(s => s.gradeLevel === topic.gradeLevel && s.area === topic.area && s.concept === topic.concept);
        const currentList = studentLists[topic.gradeLevel] || [];
        const missing = currentList.filter(name => !existing.some(r => r.name === name));
        
        const placeholders = missing.map(name => ({
          id: 'temp-' + Math.random(), gradeLevel: topic.gradeLevel, area: topic.area, concept: topic.concept,
          name, score: '', observation: 'Pendiente', date: new Date().toLocaleDateString(), createdAt: Date.now(), isNew: true
        }));

        setEditingTopic({ ...topic, records: [...existing, ...placeholders] });
      };

      const saveTopicChanges = async () => {
        const toSave = editingTopic.records.filter(r => r.name && r.score !== '');
        for (const r of toSave) {
          const normScore = parseInput((r.score ?? '').toString());
          if (r.isNew) {
            await writeRecord(createRecord(r.gradeLevel, r.area, r.name, normScore, r.concept, r.observation));
          } else {
            await writeRecord({ ...r, score: normScore, updatedAt: Date.now() });
          }
        }
        setEditingTopic(null);
        Swal.fire({ icon: 'success', title: 'Actualizado', timer: 1000, showConfirmButton: false });
      };

      // Reporte
      const downloadPivotCSV = () => {
        const filtered = students.filter(s => s.gradeLevel === reportFilter.gradeLevel && s.area === reportFilter.area);
        if (filtered.length === 0) { Swal.fire('Sin datos', 'No hay registros para este filtro', 'info'); return; }
        
        const concepts = [...new Set(filtered.map(s => s.concept))];
        const names = [...new Set(filtered.map(s => s.name))];
        
        let csv = "data:text/csv;charset=utf-8,\uFEFFEstudiante," + concepts.join(",") + "\n";
        names.forEach(name => {
          let row = [`"${name}"`];
          concepts.forEach(c => {
            const r = filtered.find(s => s.name === name && s.concept === c);
            row.push(r ? formatDisplay(r.score) : "");
          });
          csv += row.join(",") + "\n";
        });
        
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = `Planilla_${reportFilter.gradeLevel}_${reportFilter.area}.csv`;
        link.click();
      };

      // Colores UI
      const getScoreColor = (s) => {
        const n = parseFloat(parseInput(s.toString()));
        if (n >= 4.0) return 'text-green-600 bg-green-50 border-green-200';
        if (n >= 3.0) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
        return 'text-red-600 bg-red-50 border-red-200';
      };
      
      const average = students.length > 0
        ? (students.reduce((acc, curr) => acc + parseFloat(parseInput(curr.score.toString()) || 0), 0) / students.length).toFixed(1).replace('.', ',')
        : '0,0';

      return (
        <div className="min-h-screen pb-28">
          <header className="bg-lime-600 text-white p-5 rounded-b-3xl shadow-lg z-10 sticky top-0">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-lg font-bold flex items-center gap-2 uppercase">
                  <GraduationCap size={24} /> Seguimiento
                </h1>
                <p className="text-lime-100 text-[10px] font-bold tracking-widest uppercase flex items-center gap-1">
                  <KeyRound size={10} /> ID: {syncId}
                </p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setIsConfigOpen(true)} className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><Settings size={18} /></button>
                <button onClick={() => setIsReportOpen(true)} className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><FileSpreadsheet size={18} /></button>
              </div>
            </div>
          </header>

          <div className="px-4 mt-4 flex gap-2 justify-center">
            <button onClick={() => setView('recent')} className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${view === 'recent' ? 'bg-lime-600 text-white shadow-md' : 'bg-white text-slate-500 border border-slate-200'}`}>Últimos</button>
            <button onClick={() => setView('topics')} className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${view === 'topics' ? 'bg-lime-600 text-white shadow-md' : 'bg-white text-slate-500 border border-slate-200'}`}>Por Temas</button>
          </div>

          <main className="p-4 max-w-md mx-auto space-y-3">
            {view === 'recent' && (
              <>
                <div className="flex justify-between items-center px-1">
                  <h2 className="text-xs font-bold text-slate-400 uppercase">Historial General</h2>
                  <span className="text-[10px] font-bold bg-slate-200 text-slate-600 px-2 py-1 rounded">Promedio: {average}</span>
                </div>
                {students.length === 0 ? <p className="text-center text-slate-400 text-sm py-10">Sin registros en la clase {syncId}</p> : 
                  students.slice(0, 30).map(s => (
                    <div key={s.id} className="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start animate-fade-in">
                      <div className="min-w-0 pr-2">
                        <div className="flex gap-1 mb-1">
                          <span className="text-[9px] uppercase font-black bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">{s.gradeLevel}</span>
                          <span className="text-[9px] uppercase font-black bg-lime-100 text-lime-700 px-1.5 py-0.5 rounded truncate max-w-[100px]">{s.area}</span>
                        </div>
                        <h3 className="font-bold text-slate-800 text-sm">{s.name}</h3>
                        <p className="text-xs text-slate-500 truncate">{s.concept}</p>
                      </div>
                      <div className="text-right">
                        <span className={`block font-mono font-bold text-lg px-2 py-0.5 rounded border ${getScoreColor(s.score)}`}>{formatDisplay(s.score)}</span>
                        <button onClick={() => removeRecord(s.id)} className="text-[10px] text-slate-300 hover:text-red-500 mt-1 uppercase font-bold">Borrar</button>
                      </div>
                    </div>
                  ))
                }
              </>
            )}

            {view === 'topics' && (
              <>
                <div className="bg-lime-50 p-4 rounded-xl border border-lime-100 mb-4">
                  <div className="grid grid-cols-2 gap-3">
                    <select value={topicFilter.gradeLevel} onChange={(e) => setTopicFilter({...topicFilter, gradeLevel: e.target.value})} className="p-2 text-xs border border-lime-200 rounded-lg">
                      <option value="">Grado...</option>{gradeLevels.map(g => <option key={g} value={g}>{g}</option>)}
                    </select>
                    <select value={topicFilter.area} onChange={(e) => setTopicFilter({...topicFilter, area: e.target.value})} className="p-2 text-xs border border-lime-200 rounded-lg">
                      <option value="">Área...</option>{areas.map(a => <option key={a} value={a}>{a}</option>)}
                    </select>
                  </div>
                </div>
                {(!topicFilter.gradeLevel || !topicFilter.area) ? <div className="text-center text-slate-400 text-sm py-8">Selecciona filtros para ver temas.</div> :
                  topics.map(t => (
                    <div key={t.id} onClick={() => openTopicEditor(t)} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 active:scale-95 transition-transform flex justify-between items-center cursor-pointer animate-slide-up">
                      <div>
                        <h3 className="font-bold text-slate-800 leading-tight">{t.concept}</h3>
                        <p className="text-xs text-slate-500 mt-1">{t.count} Evaluados</p>
                      </div>
                      <div className="flex gap-2">
                         <div className="bg-lime-50 text-lime-600 p-2 rounded-lg"><Edit2 size={16} /></div>
                         <button onClick={(e) => deleteTopic(e, t)} className="bg-red-50 text-red-500 p-2 rounded-lg"><Trash2 size={16} /></button>
                      </div>
                    </div>
                  ))
                }
              </>
            )}
          </main>

          <button onClick={() => setIsFormOpen(true)} className="fixed bottom-6 right-6 bg-lime-600 hover:bg-lime-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40">
            <Plus size={28} />
          </button>

          {/* MODAL CONFIG */}
          {isConfigOpen && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-sm h-[70vh] rounded-2xl flex flex-col shadow-2xl animate-slide-up">
                <div className="p-4 bg-slate-800 text-white flex justify-between items-center rounded-t-2xl">
                  <h3 className="font-bold flex gap-2"><Users size={18}/> Estudiantes</h3>
                  <button onClick={() => setIsConfigOpen(false)}><X size={20}/></button>
                </div>
                <div className="p-4 border-b">
                   <select value={configGrade} onChange={e => setConfigGrade(e.target.value)} className="w-full p-2 border rounded-lg">{gradeLevels.map(g=><option key={g} value={g}>{g}</option>)}</select>
                </div>
                <div className="flex-1 overflow-y-auto p-4">
                  <div className="flex gap-2 mb-4">
                    <input type="text" value={newStudentName} onChange={e => setNewStudentName(e.target.value)} placeholder="Nuevo Estudiante" className="flex-1 p-2 border rounded-lg text-sm" />
                    <button onClick={addStudentToList} className="bg-lime-600 text-white p-2 rounded-lg"><Plus/></button>
                  </div>
                  <div className="space-y-2">
                    {(studentLists[configGrade] || []).map((name, i) => (
                      <div key={i} className="flex justify-between p-2 bg-slate-50 rounded border text-sm">
                        <span>{name}</span>
                        <button onClick={() => removeStudentFromList(name)} className="text-red-400"><Trash2 size={14}/></button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* MODAL NUEVA NOTA */}
          {isFormOpen && (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
              <div className="bg-white w-full max-w-lg h-[90vh] sm:h-auto rounded-t-2xl sm:rounded-2xl flex flex-col animate-slide-up">
                <div className="p-4 border-b flex justify-between items-center">
                  <h3 className="font-bold text-lg">Nueva Actividad</h3>
                  <button onClick={() => setIsFormOpen(false)} className="bg-slate-100 p-2 rounded-full"><X size={20}/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                  {error && <div className="bg-red-50 text-red-600 p-2 rounded text-xs font-bold text-center">{error}</div>}
                  <div className="grid grid-cols-2 gap-2">
                    <select name="gradeLevel" value={batchData.gradeLevel} onChange={handleBatchConfigChange} className="p-2 border rounded-lg bg-slate-50 text-sm font-bold">
                      <option value="">Grado...</option>{gradeLevels.map(g => <option key={g} value={g}>{g}</option>)}
                    </select>
                    <select name="area" value={batchData.area} onChange={handleBatchConfigChange} className="p-2 border rounded-lg bg-slate-50 text-sm font-bold">
                      <option value="">Área...</option>{areas.map(a => <option key={a} value={a}>{a}</option>)}
                    </select>
                  </div>
                  <input type="text" name="globalConcept" placeholder="Título de la Actividad (Ej: Taller Sumas)" value={batchData.globalConcept} onChange={handleBatchConfigChange} className="w-full p-3 border-2 border-lime-200 rounded-xl focus:outline-none focus:border-lime-500 font-bold text-lime-900 placeholder:font-normal" />
                  
                  <div className="space-y-2">
                     {batchData.entries.map((entry, idx) => (
                       <div key={idx} className="flex items-center gap-2 p-2 border rounded-lg">
                         <input type="text" value={entry.name} onChange={e => handleEntryChange(idx, 'name', e.target.value)} className="w-[40%] text-sm font-bold bg-transparent outline-none" placeholder="Estudiante" readOnly={!!studentLists[batchData.gradeLevel]?.length} />
                         <input type="text" inputMode="decimal" value={entry.score} onChange={e => handleEntryChange(idx, 'score', e.target.value)} className="w-14 text-center p-1 border rounded font-bold" placeholder="0,0" />
                         <input type="text" value={entry.observation} onChange={e => handleEntryChange(idx, 'observation', e.target.value)} className="flex-1 text-xs p-1 bg-slate-50 rounded outline-none" placeholder="Obs..." />
                       </div>
                     ))}
                     {(!batchData.gradeLevel || !studentLists[batchData.gradeLevel]?.length) && (
                        <button onClick={() => setBatchData(p => ({...p, entries: [...p.entries, {name:'', score:'', observation:''}]}))} className="text-xs text-lime-600 font-bold flex items-center gap-1"><Plus size={12}/> Agregar fila manual</button>
                     )}
                  </div>
                </div>
                <div className="p-4 border-t">
                  <button onClick={handleSaveBatch} className="w-full bg-lime-600 text-white font-bold py-3 rounded-xl shadow-lg flex justify-center gap-2"><Save size={20}/> Guardar Notas</button>
                </div>
              </div>
            </div>
          )}

          {/* MODAL EDITOR TEMA */}
          {editingTopic && (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
              <div className="bg-white w-full max-w-lg max-h-[90vh] rounded-2xl flex flex-col shadow-2xl animate-slide-up">
                 <div className="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                   <div>
                     <h3 className="font-bold">{editingTopic.concept}</h3>
                     <p className="text-xs uppercase text-slate-500">{editingTopic.gradeLevel}</p>
                   </div>
                   <button onClick={() => setEditingTopic(null)}><X size={20}/></button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-4 space-y-2">
                    {editingTopic.records.map(r => (
                      <div key={r.id} className="flex items-center gap-2 p-2 border rounded bg-white">
                        <span className="w-[40%] text-sm font-bold truncate">{r.name}</span>
                        <input type="text" inputMode="decimal" value={formatDisplay(r.score)} onChange={e => {
                           const val = e.target.value;
                           if(validateScoreInput(val)) {
                             setEditingTopic(prev => ({...prev, records: prev.records.map(rec => rec.id===r.id ? {...rec, score: val} : rec)}))
                           }
                        }} className="w-14 text-center border rounded font-bold p-1" />
                        <input type="text" value={r.observation} onChange={e => setEditingTopic(prev => ({...prev, records: prev.records.map(rec => rec.id===r.id ? {...rec, observation: e.target.value} : rec)}))} className="flex-1 text-xs bg-slate-50 p-1 rounded" placeholder="Obs..." />
                      </div>
                    ))}
                 </div>
                 <div className="p-4 border-t">
                   <button onClick={saveTopicChanges} className="w-full bg-lime-600 text-white font-bold py-3 rounded-xl"><Save size={18} className="inline mr-2"/> Actualizar</button>
                 </div>
              </div>
            </div>
          )}
          
          {/* MODAL REPORTE */}
          {isReportOpen && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
               <div className="bg-white p-6 rounded-2xl w-full max-w-sm animate-slide-up">
                  <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><FileSpreadsheet/> Descargar Planilla</h3>
                  <div className="space-y-3 mb-6">
                    <select value={reportFilter.gradeLevel} onChange={e => setReportFilter({...reportFilter, gradeLevel: e.target.value})} className="w-full p-2 border rounded-lg">{gradeLevels.map(g=><option key={g} value={g}>{g}</option>)}</select>
                    <select value={reportFilter.area} onChange={e => setReportFilter({...reportFilter, area: e.target.value})} className="w-full p-2 border rounded-lg">{areas.map(a=><option key={a} value={a}>{a}</option>)}</select>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setIsReportOpen(false)} className="flex-1 border border-slate-300 p-3 rounded-xl font-bold text-slate-500">Cancelar</button>
                    <button onClick={downloadPivotCSV} className="flex-1 bg-emerald-600 text-white p-3 rounded-xl font-bold shadow-lg flex justify-center gap-2"><Download/> CSV</button>
                  </div>
               </div>
            </div>
          )}

        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
